---
title: One Question One Answer for MQ
date: 2021-03-03 09:14:59
tags:
---



#### Q: 为什么要用 MQ？MQ 的优缺点？

A: 优点：1. 解耦 2. 异步 3. 消峰。

​     缺点：1. 可用性降低 2. 复杂性变高 3. 存在一致性问题



#### Q: Kafka、RabbitMQ、RocketMQ 的比较 

A: 

|            | ActiveMQ                   | RabbitMQ                                                     | Kafka                                                        | RocketMQ                                                |
| ---------- | -------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------- |
| 吞吐量     | 万级                       | 万级                                                         | 百万级                                                       | 十万级                                                  |
| 时效性     | ms级                       | 微秒级                                                       | ms级                                                         | ms级                                                    |
| 可用性     | 主从架构                   | 主从架构                                                     | 分布式、多副本                                               | 分布式                                                  |
| 消息可靠性 | 低概率丢消息               |                                                              | 配置参数可以做到0丢失                                        | 配置参数可以做到0丢失                                   |
| 优缺点     | 成熟、功能完善、社区不活跃 | 基于elang语言开发，性能好，有比较好的UI，社区活跃，二次开发难度大 | 超高吞吐，高可用性，大数据实时计算和日志采集场景的事实上业内标准 | topic数量多性能也还好，社区比较活跃，在阿里有大规模应用 |

#### Q: 如何保证 MQ 高可用？

A: 

1. RabbitMQ 三种模式：单机模式、普通集群模式、镜像集群模式。单机模式和普通集群模式无法保证MQ高可用，镜像集群模式可用保证高可用。
2. Kafka 可以使用 Leader/Follower 模式，partition leader ，增加节点作为 follower，生产者往 leader 上写消息，消费者从 leader 消费消息，leader 向 follower 同步数据，如果 leader 宕机了，Kafka 会将 follower 提成 leader 保证 MQ 高可用。



#### Q: 如何保证消息可靠？消息丢失怎么办？

A: 

1. RabbitMQ 

   生产者使用 confirm 模式，可以保证消息在生产者一方不丢失。

   RabbitMQ server 开启同步落盘，保证消息持久化到磁盘才给生产者返回 confirm 保证在 MQ server 消息不丢。

   消费者使用手动 ack 模式，保证消息在消费者一方不丢失。

2. Kafka 

   生产者

   broker 设置

   消费者使用手动 ack 



#### Q: 如何保证消息顺序性？ 

A: 

1. RabbitMQ

   需要保证顺序的消息发送到同一个 queue 中，一个 queue 只有一个 consumer 消费。

2. Kafka

   需要保证顺序的消息发送到通一个 partition ，一个 consumer 消费一个 partition，此时需要单线程才能保证消息顺序，如果要提高吞吐量，使用多线程，可以使用内存队列，将需要保证顺序的消息发送到相同的内存队列，由一个线程消费。



#### Q: 如何解决消息延时和过期失效的问题？ 

A:  一般不会设置消息时效，如果真的失效了，只能自己写一个程序从源头开始一条一条手动补数据。



#### Q: 消息队列满了如何处理？如何解决消息积压？

A:  MQ 磁盘满了，一般情况都是消费者程序出了问题，可以修改消费者程序，将消费快速消费丢弃掉，保证 MQ 不会因为磁盘满了挂掉。

如果有大量的消息积压，一般情况也是消费者程序出了问题，可以建一个新的 topic ，这个 topic 多搞几个消费者，比如原来是 3 个，现在可以弄 30 个，然后修改消费者程序，将消息导到这个新的 topic 中，由 30 个消费者消费，这样消息的消费速度就是原来的 10 倍。



#### Q: 如何设计一个 MQ 架构。

A: 